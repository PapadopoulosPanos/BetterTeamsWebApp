@model List<BetterTeamsWebApp.Models.ViewModels.MessageVM>
@{

    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="container">
    <div class="messaging">
        <div class="inbox_msg">
            <div class="mesgs">
                <div id="postBox" class="msg_history">

                </div>
                <!--Type Post-->
                <div class="type_msg ">
                    <div class="input_msg_write">
                        <input id="pst" class="write_msg" placeholder="Type a message" />
                        <button id="btn" onclick="clickToPost()" class="msg_send_btn">s</button>
                        <input id="crntRoom" type="hidden" value="General" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section postscripts{
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script>

        

        function Now() {
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1;
            var yyyy = today.getFullYear();

            var hh = today.getHours();
            var min = today.getMinutes();
            var ss = today.getSeconds();

            if (dd < 10) {
                dd = '0' + dd;
            }
            if (mm < 10) {
                mm = '0' + mm;
            }
            var today = dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + min + ':' + ss;
            return today;
        }

        var postTxt = document.getElementById("pst");
        var currentRoom = document.getElementById("crntRoom");

        postTxt.addEventListener("keyup", (event) => {
            if (event.keyCode === 13) {
                sendPost(postTxt.value, currentRoom.value)
                postTxt.value = "";
            }

        })
        var clickToPost = (txt) => {
            txt = postTxt.value;
            sendPost(txt, currentRoom.value)
            postTxt.value = "";
        }


        var setRoom = (id) => {
            previd = id;
            $("#" + previd).removeClass('text-white');
            $("#" + previd).addClass("text-primary bg-white");
            ofRoom = document.getElementById(previd).getAttribute("value");
            console.log(ofRoom);
            let c = document.getElementById("postBox");
            c.innerHTML = "";
            currentRoom.value = ofRoom;
            RoomHandler(ofRoom);
        }

       

        window.addEventListener("load", () => {
            const chub = $.connection.chatHub;
            chub.client.stopClient = function () {
                $.connection.hub.stop();
            };
        });
        

            var sendPost = (p, r) => {
                Sender = "@User.Identity.Name";
                DateTime = Now();
                $.ajax({
                    //"application/json;charset=utf-8"
                    url: '/Home/SendPost',
                    type: 'POST',
                    dataType: 'json',
                    data: { PostText: `${p}`, Sender: `${Sender}`, Room: `${r}`, dateTime: `${DateTime}` },
                    success: function (data) {
                        var pBox = document.getElementById('postBox');
                        console.log("success");
                        console.log(postBox);
                        console.log(data);
                        pBox.innerHTML += addPost(data);
                    },
                    error: function (request, message, error) {
                        console.log(request);
                        console.log(error);
                        console.log(message);
                    }
                });

            }

        refresh = document.getElementById("postBox");
        //refresh.addEventListener("change", () => {
        //    location = location;
        //});
        $("#postBox").change(function () {
            location = location;
        });
         
         var postsListSuccess = (Posts) => {
             let postBox = document.getElementById("postBox");
             $.each(Posts, (index, post) => {
               postBox.innerHTML += addPost(post);
            });
         }

        var addPost = (p) => {
            let dpost = Now();
            let postBubble;
            postBubble = '<div class="outgoing_msg">' +
                '<div class="sent_msg">' +
                '<span class="time_user">' + p.Sender + '</span>' +
                '<p>' + p.PostText + '</p>' +
                '<span class="time_user">' + dpost + '</span>' +
                '</div></div></div>';
            return postBubble;
        }

        var RoomHandler = (r) => {
            $.ajax({
                url: '/Home/GetPostsOfRoom',
                type: 'Get',
                data: { Room: `${r}` },
                dataType: 'json',
                success: function (pList) {
                    postsListSuccess(pList);
                },
                error: function (request, message, error) {
                    console.log(request);
                    console.log(error);
                    console.log(message);
                }

            });
        }

        window.setInterval(function () {
            var elem = document.getElementById('postBox');
            elem.scrollTop = elem.scrollHeight;
        }, 500);

    </script>

}